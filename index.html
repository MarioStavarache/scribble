<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; background-color:rgb(88, 88, 247);}
      form { 
        background: #000;        
      }
      form input { border: 0; padding: 10px; width: 80%; }
      form button { width: 20%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0;}
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
      #nickname {
        border: 0; 
        padding: 10px; 
        width: 80%;
      }
      #nickSelect {
        width: 20%;
        background: rgb(130, 224, 255); 
        border: none; 
        padding: 10px;
      }
      #drawboard {  
        margin-top: 10px; 
        margin-left: 10px;
        margin-bottom: 10px;
        height: 500px;
        width: 60%;
      }
      #drawfield {
        background-color: white; 
        height: 500px;
      }
      #menubar {
        margin-top: 10px;
      }
      #chatbox {
        background-color:white;
        float: right;
        width: 250px;
        margin-top: 10px;
        margin-right: 10px;
        height: 500px; 
        overflow: auto;
      }
      #timebox{
        margin-right: 10px;
        margin-left: 90%;
        float: right;
      }
      .box {
        float: left;
      }
      #wordlist {
        margin-left: 75%;
      }
    </style>
  </head>
  <body>
    <div id="drawboard" class="box">
      <canvas id="drawfield">
      </canvas>
      <div id="menubar">
        <input type="button" id="butBlack" style="background-color: black; width: 20px;">
        <input type="button" id="butRed" style="background-color: red; width: 20px;">
        <input type="button" id="butBlue" style="background-color: blue; width: 20px;">
        <input type="button" id="butGreen" style="background-color: green; width: 20px;">
        <br>
        <input type="button" id="butReset" style="background-color: rgb(151, 147, 147); height: 25px;" value="Delete">
      </div>
    </div>
    <div id="chatbox" class="box">  
      <input id="nickname" autocomplete="off" placeholder="Nickname"><button id="nickSelect">Select</button> 
      <ul id="messages"></ul>
      <form action="">
          <input id="m" autocomplete="off" placeholder="Message"/><button>Send</button>
      </form>
    </div>
    <div id="timebox">
      <label>Time left:</label>
      <label id="time">60</label>
      <label>s</label>
    </div>
    <div id="wordlist">
        <input type="radio" name="drawword" id="radio1"><label id="word1">Baum</label><br>
        <input type="radio" name="drawword" id="radio2"><label id="word2">Auto</label><br>
        <input type="radio" name="drawword" id="radio3"><label id="word3">Haus</label>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.dev.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      $(function () {
        var socket = io();

        $('#drawboard *').prop('disabled', true);
        $('#wordlist').css('display', 'none');
        $('form *').prop('disabled', true);
        $('#drawfield').css("pointer-events", "none");
        
        var canvas = document.getElementById('drawfield');
        var context = canvas.getContext('2d');
        $('#butBlack').on('click', function(){
          context.fillStyle = 'rgb(0, 0, 0)';
          context.storkeStyle = 'rgb(0, 0, 0)';
        });
        $('#butRed').on('click', function(){
          context.fillStyle = 'rgb(255, 0, 0)';
          context.strokeStyle = 'rgb(255, 0, 0)';
        });
        $('#butGreen').on('click', function(){
          context.fillStyle = 'rgb(0, 255, 0)';
          context.strokeStyle = 'rgb(0, 255, 0)';
        });
        $('#butBlue').on('click', function(){
          context.fillStyle = 'rgb(0, 0, 255)';
          context.strokeStyle = 'rgb(0, 0, 255)';
        });
        $('#butReset').on('click', function(){
          context.clearRect(0, 0, canvas.width, canvas.height);
          socket.emit('clear');
        });

        var radius = 1;
        context.lineWidth = 2;
        var dragging = false;
        var engage = function(e){
          dragging = true;
          putPoint(e);
        }
        var putPoint = function(e){
          if (dragging) {
            context.lineTo(e.clientX, e.clientY);
            context.stroke();
            context.beginPath();
            context.arc(e.clientX, e.clientY, radius, 0, Math.PI*2);
            context.fill();
            context.beginPath();
            context.moveTo(e.clientX, e.clientY);
            var color = context.getImageData(e.clientX, e.clientY, 1, 1).data;
            sendMouse(e.clientX, e.clientY, color, dragging);
          }
          var color = context.getImageData(e.clientX, e.clientY, 1, 1).data;
          sendMouse(e.clientX, e.clientY, color, dragging);
        }

        var disengage = function(e){
          dragging = false;
          context.beginPath();
        }

        function sendMouse(posX, posY, color, dragging) {
          var data = {
            x: posX,
            y: posY,
            c: color,
            d: dragging
          };
          socket.emit('mouse', data);
        }

        function rgbToHex(r, g, b) {
          if (r > 255 || g > 255 || b > 255)
              throw "Invalid color component";
          return ((r << 16) | (g << 8) | b).toString(16);
        }
        var time;
        var countdown = function() {
          canvas.removeEventListener('mousedown', countdown);
          time = document.getElementById('time').innerHTML;
          time = parseInt(time);
          if (time == 1) {
            context.clearRect(0, 0, canvas.width, canvas.height);
            canvas.addEventListener('mousedown', countdown);
            document.getElementById('time').innerHTML = "60";
            $('#wordlist').css('display', 'block');
            return;
          }
  
          time--;
          socket.emit('time', time);
          document.getElementById('time').innerHTML = time;
          timeout = setTimeout(countdown, 1000);
        } 
        canvas.addEventListener('mousedown', engage);
        canvas.addEventListener('mousedown', countdown);
        canvas.addEventListener('mousemove', putPoint);
        canvas.addEventListener('mouseup', disengage);

        var word;
        $('#radio1').click(function(){
          word = $('#word1').text();
          $('#wordlist').css('display', 'none');
          $('#drawboard *').prop('disabled', false);
          $('#drawfield').css("pointer-events", "auto");
        })       
        $('#radio2').click(function(){
          word = $('#word2').text();
          $('#wordlist').css('display', 'none');
          $('#drawboard *').prop('disabled', false);
          $('#drawfield').css("pointer-events", "auto");
        })   
        $('#radio3').click(function(){
          word = $('#word3').text();
          $('#wordlist').css('display', 'none');
          $('#drawboard *').prop('disabled', false);
          $('#drawfield').css("pointer-events", "auto");
        })    

        $('#nickSelect').on('click', function(){
          $('#wordlist').css('display', 'block');
          $('#nickname').css('display', 'none');
          $('#nickSelect').css('display', 'none');
          $('form *').prop('disabled', false);

          socket.on('connect message', function(name){
            $('#messages').append($('<li>').text(name + " connected"));
          });
          socket.emit('connect message', $('#nickname').val());
        });

        socket.on('time', function(time){
          var canvas = document.getElementById('drawfield');
          var context = canvas.getContext('2d');
          document.getElementById('time').innerHTML = time;
          if (time == 1) {
            timeout = setTimeout(function(){
              context.clearRect(0, 0, canvas.width, canvas.height);
              canvas.addEventListener('mousedown', countdown);
              document.getElementById('time').innerHTML = "60";
              $('#wordlist').css('display', 'block');
              return;
            }, 1000);
          }
        });

        socket.on('clear', function(){
          var cCanvas = document.getElementById('drawfield');
          var context = cCanvas.getContext('2d');
          context.clearRect(0, 0, cCanvas.width, cCanvas.height);
        });

        socket.on('mouse', function(data) {
          var canvasNew = document.getElementById('drawfield');
          var contextNew = canvasNew.getContext('2d');
          var hex = "#" + ("000000" + rgbToHex(data.c[0], data.c[1], data.c[2])).slice(-6);
          contextNew.fillStyle = hex;
          contextNew.strokeStyle = hex;
          if (data.d) {
            context.lineTo(data.x, data.y);
            context.stroke();
            context.beginPath();
            context.lineWidth = 2;
            contextNew.arc(data.x, data.y, 1, 0, Math.PI*2);
            contextNew.fill();
            contextNew.beginPath();
            contextNew.moveTo(data.x, data.y);
          } else {
            contextNew.beginPath();
          }
        });

        $('form').submit(function(){
          socket.emit('chat message', $('#m').val(), $('#nickname').val());
            $('#m').val('');
            return false;
          });
          socket.on('chat message', function(msg, name){
            $('#messages').append($('<li>').text(name + ": "  + msg));
          });
      });
    </script>  
  </body>
</html>